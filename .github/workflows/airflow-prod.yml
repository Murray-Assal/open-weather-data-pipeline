name: Run Airflow Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # optional: weekly at 12 AM UTC

jobs:
  run-airflow-dag:
    runs-on: ubuntu-latest
    env:
      OPEN_WEATHER_APP_API: ${{ secrets.OPEN_WEATHER_APP_API }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: docker compose -f docker-compose.yaml up -d postgres postgres-data

      - name: Build and start Airflow services
        run: |
          docker compose -f docker-compose.yaml build
          docker compose -f docker-compose.yaml up -d airflow-scheduler airflow-triggerer airflow-dag-processor airflow-apiserver airflow-init

      - name: Wait for scheduler and DAGs to be ready
        run: |
          echo "Waiting 30s for scheduler to pick up DAGs..."
          sleep 30
          docker compose -f docker-compose.yaml run --rm airflow-cli airflow dags list

      - name: Test environment variable
        run: |
          echo "Checking OPEN_WEATHER_APP_API..."
          docker compose run --rm airflow-cli bash -c 'echo $OPEN_WEATHER_APP_API'

      - name: Test Postgres connection exists
        run: |
          echo "Checking Postgres connection..."
          docker compose run --rm airflow-cli airflow connections list | grep postgres_database || \
          docker compose run --rm airflow-cli \
            airflow connections add postgres_database \
            --conn-uri postgresql+psycopg2://postgres:postgres@postgres-data:5432/weather_data

      - name: Test OpenWeatherMap connection exists
        run: |
          echo "Checking OpenWeatherMap connection..."
          docker compose run --rm airflow-cli airflow connections list | grep open_weather_map_api || \
          docker compose run --rm airflow-cli \
            airflow connections add open_weather_map_api --conn-uri "https://api.openweathermap.org"
      
      - name: Unpause DAG
        run: docker compose run --rm airflow-cli airflow dags unpause open_weather_map_dag

      - name: Trigger DAG and get run_id
        id: trigger_dag
        run: |
          DAG_ID=open_weather_map_dag
          echo "Triggering DAG $DAG_ID..."
          RUN_ID=$(docker compose run --rm airflow-cli \
            airflow dags trigger -r github_action_run $DAG_ID --conf '{}' --output json \
            | jq -r '.[0].dag_run_id')
          if [ -z "$RUN_ID" ]; then
            echo "Failed to trigger DAG"
            exit 1
          fi
          echo "Triggered DAG run_id: $RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Wait for DAG run to complete
        run: |
          DAG_ID=open_weather_map_dag
          RUN_ID=${{ steps.trigger_dag.outputs.run_id }}
          MAX_RETRIES=10
          SLEEP_SECONDS=5
          COUNTER=0

          echo "Polling DAG run status..."
          while [ $COUNTER -lt $MAX_RETRIES ]; do
            STATUS=$(docker compose run --rm airflow-cli airflow dags state $DAG_ID $RUN_ID)
            echo "DAG run status: $STATUS"
            if [[ "$STATUS" == "success" ]]; then
              echo "DAG completed successfully!"
              exit 0
            elif [[ "$STATUS" == "failed" ]]; then
              echo "DAG failed! Fetching task logs..."
              # List all tasks
              TASKS=$(docker compose run --rm airflow-cli airflow tasks list $DAG_ID | awk 'NR>2 {print $1}' | grep -vE '^\s*$')
              for TASK_ID in $TASKS; do
                STATE=$(docker compose run --rm airflow-cli airflow tasks state $DAG_ID $TASK_ID $RUN_ID)
                echo "Task $TASK_ID: $STATE"
                if [[ "$STATE" == "failed" ]]; then
                  echo "---------- LOGS FOR FAILED TASK: $TASK_ID ----------"
                  docker compose run --rm airflow-cli airflow tasks logs $DAG_ID $TASK_ID $RUN_ID || true
                  echo "----------------------------------------------------"
                fi
              done
              exit 1
            fi
            COUNTER=$((COUNTER + 1))
            sleep $SLEEP_SECONDS
          done

          echo "DAG did not complete within expected time."
          exit 1

      - name: Tear down Airflow services
        if: always()
        run: docker compose -f docker-compose.yaml down -v
