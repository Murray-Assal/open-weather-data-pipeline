name: Run Airflow Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # optional: weekly at 12 AM UTC

jobs:
  run-airflow-dag:
    runs-on: ubuntu-latest
    env:
      OPEN_WEATHER_APP_API: ${{ secrets.OPEN_WEATHER_APP_API }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: docker compose -f docker-compose.yaml up -d postgres postgres-data

      - name: Build and start Airflow services
        run: |
          docker compose -f docker-compose.yaml build
          docker compose -f docker-compose.yaml up -d airflow-scheduler airflow-triggerer airflow-dag-processor airflow-apiserver airflow-init

      - name: Wait for scheduler and DAGs to be ready
        run: |
          echo "Waiting 30s for scheduler to pick up DAGs..."
          sleep 30
          docker compose -f docker-compose.yaml run --rm airflow-cli airflow dags list

      - name: Trigger DAG and get run_id
        id: trigger_dag
        run: |
          DAG_ID=open_weather_map_dag
          echo "Triggering DAG $DAG_ID..."
          RUN_ID=$(docker compose run --rm airflow-cli \
            airflow dags trigger -r github_action_run $DAG_ID --conf '{}' --output json \
            | jq -r '.[0].dag_run_id')
          if [ -z "$RUN_ID" ]; then
            echo "Failed to trigger DAG"
            exit 1
          fi
          echo "Triggered DAG run_id: $RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Wait for DAG run to complete
        run: |
          DAG_ID=open_weather_map_dag
          RUN_ID=${{ steps.trigger_dag.outputs.run_id }}
          MAX_RETRIES=60
          SLEEP_SECONDS=10
          COUNTER=0

          echo "Polling DAG run status..."
          while [ $COUNTER -lt $MAX_RETRIES ]; do
            STATUS=$(docker compose run --rm airflow-cli airflow dags state $DAG_ID $RUN_ID)
            echo "DAG run status: $STATUS"
            if [[ "$STATUS" == "success" ]]; then
              echo "DAG completed successfully!"
              exit 0
            elif [[ "$STATUS" == "failed" ]]; then
              echo "DAG failed!"
              exit 1
            fi
            COUNTER=$((COUNTER + 1))
            sleep $SLEEP_SECONDS
          done

          echo "DAG did not complete within expected time."
          exit 1

      - name: Tear down Airflow services
        if: always()
        run: docker compose -f docker-compose.yaml down -v
